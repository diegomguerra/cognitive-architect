name: CI iOS + TestFlight + Sync + Supabase

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ci-ios-sync-supabase-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-ios:
    name: Build iOS
    runs-on: macos-14
    permissions:
      contents: read
    steps:
      - name: Validate inputs
        env:
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_TEAM_ID: ${{ secrets.APP_STORE_CONNECT_TEAM_ID }}
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        run: |
          set -euo pipefail
          for key in APP_STORE_CONNECT_API_ISSUER_ID APP_STORE_CONNECT_API_KEY_ID APP_STORE_CONNECT_TEAM_ID APP_STORE_CONNECT_API_KEY; do
            if [ -z "${!key:-}" ]; then
              echo "Missing required secret: $key" >&2
              exit 1
            fi
          done

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build web app
        run: npm run build

      - name: Prepare iOS project
        run: |
          npx cap sync ios
          node scripts/patch-ios.mjs

      - name: Configure App Store Connect API key
        env:
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        run: |
          set -euo pipefail
          mkdir -p "$RUNNER_TEMP/private_keys"
          KEY_PATH="$RUNNER_TEMP/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8"
          printf '%s' "$APP_STORE_CONNECT_API_KEY" > "$KEY_PATH"
          echo "APP_STORE_CONNECT_API_KEY_PATH=$KEY_PATH" >> "$GITHUB_ENV"

      - name: Archive iOS app
        working-directory: ios/App
        run: |
          set -euo pipefail
          xcodebuild \
            -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -destination generic/platform=iOS \
            -archivePath "$RUNNER_TEMP/App.xcarchive" \
            -allowProvisioningUpdates \
            -authenticationKeyPath "$APP_STORE_CONNECT_API_KEY_PATH" \
            -authenticationKeyID "${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}" \
            -authenticationKeyIssuerID "${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}" \
            DEVELOPMENT_TEAM="${{ secrets.APP_STORE_CONNECT_TEAM_ID }}" \
            archive

      - name: Export IPA
        run: |
          set -euo pipefail
          cat > "$RUNNER_TEMP/ExportOptions.plist" <<PLIST
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
            <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>${{ secrets.APP_STORE_CONNECT_TEAM_ID }}</string>
              <key>signingStyle</key>
              <string>automatic</string>
            </dict>
          </plist>
          PLIST

          xcodebuild -exportArchive \
            -archivePath "$RUNNER_TEMP/App.xcarchive" \
            -exportPath "$RUNNER_TEMP/export" \
            -exportOptionsPlist "$RUNNER_TEMP/ExportOptions.plist" \
            -allowProvisioningUpdates \
            -authenticationKeyPath "$APP_STORE_CONNECT_API_KEY_PATH" \
            -authenticationKeyID "${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}" \
            -authenticationKeyIssuerID "${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}"

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: ${{ runner.temp }}/export/*.ipa
          if-no-files-found: error

  upload-testflight:
    name: Upload to TestFlight
    runs-on: macos-14
    needs: build-ios
    permissions:
      contents: read
    steps:
      - name: Validate inputs
        env:
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        run: |
          set -euo pipefail
          for key in APP_STORE_CONNECT_API_ISSUER_ID APP_STORE_CONNECT_API_KEY_ID APP_STORE_CONNECT_API_KEY; do
            if [ -z "${!key:-}" ]; then
              echo "Missing required secret: $key" >&2
              exit 1
            fi
          done

      - name: Download IPA artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-ipa
          path: ${{ runner.temp }}/export

      - name: Configure App Store Connect API key
        env:
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        run: |
          set -euo pipefail
          mkdir -p "$RUNNER_TEMP/private_keys"
          KEY_PATH="$RUNNER_TEMP/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8"
          printf '%s' "$APP_STORE_CONNECT_API_KEY" > "$KEY_PATH"

          xcrun altool --upload-app \
            --type ios \
            --file "$RUNNER_TEMP/export/$(ls "$RUNNER_TEMP/export" | head -n1)" \
            --apiKey "${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}" \
            --apiIssuer "${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}"

  sync-repo:
    name: Sync repository to target
    runs-on: ubuntu-latest
    if: github.event_name != 'push' || !contains(github.event.head_commit.message, '[skip-sync]')
    permissions:
      contents: read
    steps:
      - name: Validate inputs
        env:
          SYNC_REPO_TOKEN: ${{ secrets.SYNC_REPO_TOKEN }}
          SYNC_TARGET_REPO: ${{ vars.SYNC_TARGET_REPO }}
          SYNC_TARGET_BRANCH: ${{ vars.SYNC_TARGET_BRANCH }}
        run: |
          set -euo pipefail
          for key in SYNC_REPO_TOKEN SYNC_TARGET_REPO SYNC_TARGET_BRANCH; do
            if [ -z "${!key:-}" ]; then
              echo "Missing required input: $key" >&2
              exit 1
            fi
          done
          if [ "${GITHUB_REPOSITORY}" = "${SYNC_TARGET_REPO}" ]; then
            echo "SYNC_TARGET_REPO must be different from source repository to avoid loop sync." >&2
            exit 1
          fi

      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Build distributable assets
        run: |
          npm ci
          npm run build

      - name: Push to destination repository
        env:
          SYNC_REPO_TOKEN: ${{ secrets.SYNC_REPO_TOKEN }}
          SYNC_TARGET_REPO: ${{ vars.SYNC_TARGET_REPO }}
          SYNC_TARGET_BRANCH: ${{ vars.SYNC_TARGET_BRANCH }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          TARGET_URL="https://x-access-token:${SYNC_REPO_TOKEN}@github.com/${SYNC_TARGET_REPO}.git"
          git remote add sync-target "$TARGET_URL"

          git push sync-target "HEAD:${SYNC_TARGET_BRANCH}" --force

  supabase-deploy:
    name: Supabase deploy
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Validate inputs
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ vars.SUPABASE_PROJECT_REF }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          set -euo pipefail
          for key in SUPABASE_ACCESS_TOKEN SUPABASE_PROJECT_REF SUPABASE_DB_PASSWORD; do
            if [ -z "${!key:-}" ]; then
              echo "Missing required input: $key" >&2
              exit 1
            fi
          done

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link project and push database migrations
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          SUPABASE_PROJECT_REF: ${{ vars.SUPABASE_PROJECT_REF }}
        run: |
          set -euo pipefail
          supabase --version
          supabase link --project-ref "$SUPABASE_PROJECT_REF" --password "$SUPABASE_DB_PASSWORD"
          supabase db push --linked --password "$SUPABASE_DB_PASSWORD"

      - name: Deploy edge functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          set -euo pipefail
          shopt -s nullglob
          for fn in supabase/functions/*; do
            [ -d "$fn" ] || continue
            supabase functions deploy "$(basename "$fn")"
          done
